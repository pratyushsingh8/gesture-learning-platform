{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2>üñê Gesture Simon Says</h2>
  <p>Copy the gesture shown on the screen!</p>

  <h3 id="gestureText">‚úå Show 2 fingers</h3>

  <div class="video-wrapper">
    <video id="input_video" autoplay playsinline muted style="display:none;"></video>
    <canvas id="output_canvas" width="640" height="480" style="border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);"></canvas>
  </div>

  <p id="result"></p>
  <p id="scoreLabel" style="font-weight:bold; color:green;">Score: 0</p>

  <div style="margin-top:15px;">
    <button onclick="startGame()">‚ñ∂ Start Game</button>
    <button onclick="nextRound()">üîÑ Next Gesture</button>
  </div>
</div>

<style>
  .video-wrapper { margin-top: 15px; text-align: center; }
  #gestureText { font-size: 1.4rem; margin: 15px 0; color: #ff7043; }
  #result { font-size: 1.3rem; font-weight: bold; margin-top: 12px; }
</style>

<!-- ‚úÖ Correct Mediapipe Tasks-Vision import -->
<script type="module">
  import { HandLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0";

  let videoElement, canvasElement, canvasCtx;
  let handLandmarker;
  let targetGesture, score = 0;

  const gestures = [
    { name: "One finger", check: fs => fs.index && !fs.middle && !fs.ring && !fs.pinky, text: "‚òù Show 1 finger" },
    { name: "Two fingers", check: fs => fs.index && fs.middle && !fs.ring && !fs.pinky, text: "‚úå Show 2 fingers" },
    { name: "Fist", check: fs => !fs.index && !fs.middle && !fs.ring && !fs.pinky, text: "‚úä Make a fist" },
    { name: "Open hand", check: fs => fs.index && fs.middle && fs.ring && fs.pinky, text: "üñê Show open hand" }
  ];

  async function initHandLandmarker() {
    const vision = await FilesetResolver.forVisionTasks(
      "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.0/wasm"
    );
    handLandmarker = await HandLandmarker.createFromOptions(vision, {
      baseOptions: {
        modelAssetPath: "https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task"
      },
      numHands: 1,
      runningMode: "VIDEO"
    });
    console.log("‚úÖ HandLandmarker initialized");
  }

  async function startGame() {
    await initHandLandmarker();

    videoElement = document.getElementById("input_video");
    canvasElement = document.getElementById("output_canvas");
    canvasCtx = canvasElement.getContext("2d");

    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      videoElement.srcObject = stream;
      videoElement.play();

      function processFrame() {
        if (videoElement.readyState >= 2) {
          const results = handLandmarker.detectForVideo(videoElement, performance.now());
          drawResults(results);
        }
        requestAnimationFrame(processFrame);
      }
      processFrame();
    });

    nextRound();
  }

  function nextRound() {
    targetGesture = gestures[Math.floor(Math.random() * gestures.length)];
    document.getElementById("gestureText").innerText = targetGesture.text;
    document.getElementById("result").innerText = "";
  }

  function getFingerStates(landmarks) {
    const tips = [4,8,12,16,20];
    const pips = [2,6,10,14,18];
    let states = [];
    for (let i = 0; i < 5; i++) {
      states.push(landmarks[tips[i]].y < landmarks[pips[i]].y);
    }
    return { thumb: states[0], index: states[1], middle: states[2], ring: states[3], pinky: states[4] };
  }

  function drawResults(results) {
  canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
  canvasCtx.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);

  if (!results || !results.landmarks) return;

  for (const landmarks of results.landmarks) {
    const fs = getFingerStates(landmarks);

    if (targetGesture && targetGesture.check(fs)) {
      document.getElementById("result").innerText = "‚úÖ Correct!";
      score++;
      document.getElementById("scoreLabel").innerText = "Score: " + score;

      // prevent multiple fast triggers
      targetGesture = null;

      // Wait 3 seconds before next gesture
      setTimeout(nextRound, 3000);
    } else {
      // Only update if still expecting a gesture
      if (targetGesture) {
        document.getElementById("result").innerText = "‚ùå Try again!";
      }
    }
  }
}


  // ‚úÖ Expose functions so buttons can call them
  window.startGame = startGame;
  window.nextRound = nextRound;
</script>
{% endblock %}
